


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code>library(tidyverse)
library(lubridate)
library(highcharter)
library(htmlwidgets)
library(xts)
library(ggthemes)

time_now = with_tz(now(), &quot;Europe/Paris&quot;)
runtime_start = Sys.time()

start_day = &quot;2019-12-31&quot;
start_time = &quot;23:00:00&quot;
start_time = paste0(&quot;%5B&quot;, start_day, &quot;T&quot;, start_time, &quot;Z&quot;)

# end_day = &quot;2020-06-14&quot;
end_day = date(time_now)
# end_time = &quot;21:59:59&quot;
end_time = gsub(end_day, &quot;&quot;, time_now)
end_time = gsub(&quot;\\s+&quot;, &quot;&quot;, end_time)
end_time = paste0(end_day, &quot;T&quot;, end_time, &quot;Z%5D&quot;)

link = sprintf(&quot;https://parisdata.opendatasoft.com/api/records/1.0/analyze/?output_timezone=UTC&amp;disjunctive.libelle=true&amp;disjunctive.etat_trafic=true&amp;disjunctive.libelle_nd_amont=true&amp;disjunctive.libelle_nd_aval=true&amp;rows=1000000000000000000&amp;dataChart=eyJxdWVyaWVzIjpbeyJjaGFydHMiOlt7InR5cGUiOiJzcGxpbmUiLCJmdW5jIjoiQVZHIiwieUF4aXMiOiJxIiwic2NpZW50aWZpY0Rpc3BsYXkiOnRydWUsImNvbG9yIjoiI2ZmNWMzMyJ9XSwieEF4aXMiOiJ0XzFoIiwibWF4cG9pbnRzIjoiIiwidGltZXNjYWxlIjoiaG91ciIsInNvcnQiOiIiLCJjb25maWciOnsiZGF0YXNldCI6ImNvbXB0YWdlcy1yb3V0aWVycy1wZXJtYW5lbnRzIiwib3B0aW9ucyI6eyJkaXNqdW5jdGl2ZS5saWJlbGxlIjp0cnVlLCJkaXNqdW5jdGl2ZS5ldGF0X3RyYWZpYyI6dHJ1ZSwiZGlzanVuY3RpdmUubGliZWxsZV9uZF9hbW9udCI6dHJ1ZSwiZGlzanVuY3RpdmUubGliZWxsZV9uZF9hdmFsIjp0cnVlLCJzb3J0IjoidF8xaCIsInJvd3MiOiIxMDAwMDAwMDAwMDAwMDAwMDAwIiwicS50aW1lcmFuZ2UudF8xaCI6InRfMWg6WzIwMTktMTItMzFUMjM6MDA6MDBaIFRPIDIwMjAtMDYtMTRUMjE6NTk6NTlaXSJ9fX1dLCJkaXNwbGF5TGVnZW5kIjp0cnVlLCJhbGlnbk1vbnRoIjp0cnVlLCJ0aW1lc2NhbGUiOiIifQ%s&amp;timezone=Europe%sFParis&amp;dataset=comptages-routiers-permanents&amp;x=t_1h.year&amp;x=t_1h.month&amp;x=t_1h.day&amp;x=t_1h.hour&amp;sort=x.t_1h.year,x.t_1h.month,x.t_1h.day,x.t_1h.hour&amp;maxpoints=&amp;y.serie1-1.expr=q&amp;y.serie1-1.func=AVG&amp;y.serie1-1.cumulative=false&amp;y.serie1-2.expr=k&amp;y.serie1-2.func=AVG&amp;y.serie1-2.cumulative=false&amp;q=t_1h:%s+TO+%s&amp;lang=fr&quot;,
               &quot;%3D%3D&quot;, &quot;%2&quot;, start_time, end_time)

df = jsonlite::fromJSON(link, flatten = T)

data = df %&gt;% 
  mutate(year = df$x.year) %&gt;% 
  mutate(hour = case_when(nchar(x.hour) == 1 ~ paste0(&quot;0&quot;, x.hour),
                           TRUE ~ as.character(x.hour))) %&gt;% 
  mutate(month = case_when(nchar(x.month) == 1 ~ paste0(&quot;0&quot;, x.month),
                           TRUE ~ as.character(x.month))) %&gt;% 
  mutate(day = case_when(nchar(x.day) == 1 ~ paste0(&quot;0&quot;, x.day),
                           TRUE ~ as.character(x.day))) %&gt;% 
  mutate(time = as_datetime(sprintf(&quot;%s-%s-%s %s:00:00&quot;, year, month, day, hour))) %&gt;% 
  mutate(variable1 = `serie1-1`) %&gt;% 
  mutate(variable2 = `serie1-2`) %&gt;% 
  select(time, variable1, variable2) %&gt;% 
  pivot_longer(-time, names_to = &quot;variable&quot;, values_to = &quot;value&quot;) %&gt;% 
  mutate(label = case_when(variable == &quot;variable1&quot; ~ &quot;Débit horaire moyen&quot;,
                           variable == &quot;variable2&quot; ~ &quot;Taux d&#39;occupation horaire moyen&quot;))

subtt1 = paste0(&quot;Le débit qui correspond au nombre de véhicules ayant passé le point de comptage pendant un intervalle de temps fixe (une heure pour les données fournies).&quot;)
subtt2 = &quot;Le taux d’occupation, qui correspond au temps de présence de véhicules sur la boucle en pourcentage d’un intervalle de temps fixe (une heure pour les données fournies). Ainsi, 25% de taux d’occupation sur une heure signifie que des véhicules ont été présents sur la boucle pendant 15 minutes. Le taux fournit une information sur la congestion routière.&quot;
subtt3 = sprintf(&quot;Fait le : %s, Source: Marie de Paris/open data&quot;, time_now)

# 
# GRAPHIQUE GGPLOT
# 

data_plot = data %&gt;% 
  mutate(colour_new = case_when(time &gt;= &quot;2020-03-17&quot; ~ &quot;ok&quot;,
                                TRUE ~ &quot;other&quot;))

gg_route_paris =
  ggplot(data_plot, aes(x = time, y = value, colour = colour_new)) +
  facet_wrap(~label, scales = &quot;free&quot;) +
  geom_line(show.legend = F) +
  ggtitle(&quot;Trafic routier dans Paris&quot;) +
  labs(subtitle =  sprintf(&quot;%s\n%s\n%s&quot;, subtt1, subtt2, subtt3))

# 
# GRAPHIQUE HIGHCHART (html/javascript)
# 

data_hc = data %&gt;% 
  select(-label) %&gt;% 
  pivot_wider(., names_from = &quot;variable&quot;, values_from = &quot;value&quot;) %&gt;% 
  as.data.frame()

# file_html = file.path(Sys.getenv(&quot;USERPROFILE&quot;), &quot;Desktop&quot;, &quot;hc_chart.html&quot;)

xdata = xts(data_hc[,-1], order.by = data_hc[,1])

hc_route_paris = 
  highchart(type = &quot;stock&quot;) %&gt;% 
  hc_title(text = &quot;Trafic routier dans Paris en 2020&quot;) %&gt;% 
  hc_subtitle(text = sprintf(&quot;%s\n%s\n%s&quot;, subtt1, subtt2, subtt3)) %&gt;% 
  hc_yAxis_multiples(
    create_yaxis(2, height = c(2, 1), turnopposite = TRUE)
  ) %&gt;%
  hc_add_series(xdata$variable1, yAxis = 0, name = &quot;Débit horaire moyen&quot;, showInLegend = T) %&gt;% 
  hc_add_series(xdata$variable2, yAxis = 1, name = &quot;Taux d&#39;occupation horaire moyen&quot;, showInLegend = T) 

runtime_end = Sys.time()

run_time = as.numeric(difftime(runtime_end, runtime_start, units = &quot;secs&quot;))

export_graph(plot = hc_route_paris,
             folder_name = &quot;route_paris&quot;,
             # create_code_html = T,
             run_time = run_time,
             perim = &quot;FR&quot;,
             update = T )


# saveWidget(hc, file = file_html)</code></pre>

