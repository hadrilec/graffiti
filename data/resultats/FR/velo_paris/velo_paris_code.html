


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code>shinyServer(function(input, output, session) {
  
  observe({Print(input$tabs_menu)})
  
  DB_variables_react &lt;- reactive({
    DB_variables %&gt;% 
      arrange(perim)
  })
  
  link_code_file &lt;- reactiveVal()
  
  gg_react &lt;- reactiveValues()
  values &lt;- reactiveValues(df_data = NULL)
  
  var_name &lt;- reactiveVal()
  
  file_gg  &lt;- reactiveVal()
  current_plot  &lt;- reactiveVal()
  update_plot  &lt;- reactiveVal()
  update_plot_finished  &lt;- reactiveVal()
  run_time_plot  &lt;- reactiveVal()
  DB_plot_cahier &lt;- reactiveVal()
  code_related_title &lt;- reactiveVal()
  page_code = reactiveVal()
  
  observeEvent({var_name()},{
    
    Print(var_name())
    
    gg = current_plot()
    
    if(input$select_title != &quot;&quot;){
      if(!is.null(var_name())){
        if(&quot;ggplot&quot; %in% class(gg)){
          updateSelectizeInput(session, &quot;cahier&quot;, 
                               choices = c(var_name(), input$cahier), selected = input$cahier)
        }else{
          updateSelectizeInput(session, &quot;cahier&quot;, 
                               choices = c(input$cahier), selected = input$cahier)
        }
       
      }
    }
    
  })
  
  # 
  # ajout bouton MAJ graphique si disponible ####
  # 
  observe({

    render_update_button = FALSE

    if(!is.null(update_plot())){
      if(update_plot()){
        if(!is.null(link_code_file())){
          if(file.exists(link_code_file())){
            render_update_button = TRUE
          }
        }
      }
    }
    if(input$select_title == &quot;&quot;){
      render_update_button = FALSE
    }

    Print(update_plot())
    Print(link_code_file())
    Print(render_update_button)
    
    if(render_update_button){
      output$MAJ_plot &lt;- renderUI({
        actionButton(&quot;MAJ_plot&quot;, label = &quot;MAJ du graphique&quot;, icon(&quot;refresh&quot;))
      })
    }else{
      output$MAJ_plot &lt;- renderUI({NULL})
    }
    Print(render_update_button)
  })
  
  # 
  # declenchement MAJ du graphique ####
  # 
  
  observeEvent({input$MAJ_plot},{
    
    Print(input$MAJ_plot)
    Print(update_plot())
    Print(link_code_file())
    
    if(!is.null(update_plot())){
      if(update_plot()){
        if(!is.null(link_code_file())){
          
          print(&quot;plot update triggered &quot;)
          Print(link_code_file())
          
          run_time_plot_final = 30
          
          if(!is.null(run_time_plot())){
            if(is.numeric(run_time_plot())){
              run_time_plot_final = round(run_time_plot()) + 1
            }
          }
          
          withProgress(message = &#39;MAJ du graphique&#39;, detail = &quot;&quot;,{
                         # N = 60
                         for(i in 1:run_time_plot_final){
                           
                           # Long Running Task
                           Sys.sleep(1)
                           
                           # Update progress
                           incProgress(1/run_time_plot_final,
                                       detail = paste(round(i/run_time_plot_final*100), &quot;%&quot;))
                         }
                         
                         source_plot = try(source(link_code_file(), encoding = &quot;utf-8&quot;))
                       })
          
         if(class(source_plot) != &#39;try-error&#39;){
           
           print(&#39;update completed&#39;)
           
           update_plot_finished(sample(1:100))  
           
  
         }
        }
      }
    }
    
  })
  
  
  # 
  # MAJ des variables et titres proposés en fonction du périmètre indiqué ####
  # 
  observeEvent({input$select_perim},{
    
    perim &lt;- input$select_perim
    
    Print(input$select_perim)
    
    if(!is.null(perim)){
      if (perim != &quot;&quot;){
        
        title_select = 
          DB_variables_react() %&gt;% 
          filter(perim %in% c(input$select_perim)) %&gt;% 
          pull(title) %&gt;% 
          unique()
        
        if(!input$select_title %in% title_select){
          title_selected = NULL
        }else{
          title_selected = input$select_title
        }
        
        updateSelectizeInput(session, &quot;select_title&quot;, 
                             choices = title_select, 
                             selected = title_selected)
       
        
      }else{
        print(&quot;select_title null&quot;)
        updateSelectizeInput(session, &quot;select_title&quot;, choices = &quot;&quot;)
      }
    }else{
      print(&quot;select_title null&quot;)
      updateSelectizeInput(session, &quot;select_title&quot;, choices = &quot;&quot;)
    }
   
  })
  
  # 
  # MAJ du titre en fonction de la variable indiquée et inversement ####
  #
  dico_table_react &lt;- reactiveVal()
  
  observe({
    
    dico_table = DB_variables_react() %&gt;%
      select(perim, var, title) %&gt;%
      dplyr::rename(`Périmètre` = perim,
                    Variable = var,
                    Titre = title) %&gt;% 
      as.data.frame() 
    
      dico_table = dico_table %&gt;% 
        DT::datatable(filter = &quot;top&quot;, selection = &quot;single&quot;) %&gt;%
        DT::formatStyle(0, lineHeight = &#39;10px&#39;, target= &#39;row&#39;) 
    
    
    dico_table_react(dico_table)
    
    output$dico_home_page &lt;- DT::renderDT(dico_table_react()) 
  })
  
  observeEvent({
    input$dico_home_page_cell_clicked
  },{
    
    row_selected = input$dico_home_page_cell_clicked$row[1]
    
    Print(row_selected)

    if(!is.null(row_selected)){
  
        title_selected = 
          DB_variables_react() %&gt;%
          slice(row_selected) %&gt;%
          pull(title)

          perim_selected =
            DB_variables_react() %&gt;%
            slice(row_selected) %&gt;%
            pull(perim)

          title_choices =
            DB_variables_react() %&gt;%
            filter(perim == perim_selected) %&gt;%
            pull(title)

          updateSelectizeInput(session, &quot;select_title&quot;,
                               choices = title_choices,
                               selected = title_selected)

          updatePickerInput(
            session,
            &quot;select_perim&quot;,
            label = NULL,
            selected = perim_selected,
            choices = countries,
            choicesOpt = list(content = icons_perims)
          )
      

    }
  })
  
  observeEvent({
    input$select_title
    input$interact_plot
    update_plot_finished()
  },
  ignoreNULL = FALSE, ignoreInit = FALSE,
  handlerExpr = {
    print(&quot; &quot;)
    print(&quot;start  &quot;)
    
    Print(input$tabs)
    Print(input$select_perim)
    Print(input$select_title)
    
    perim &lt;- input$select_perim
      
      list_tab2 = list()
      
  
      if(input$select_perim != &quot;&quot;){
      if(input$select_title != &quot;&quot;){
        
        var = DB_variables_react() %&gt;% 
          dplyr::filter(title %in% c(input$select_title)) %&gt;% 
          filter(perim %in% c(input$select_perim)) %&gt;% 
          slice(1) %&gt;% 
          pull(var) %&gt;% 
          unique() 
      
        
        # 
        # chargement du graphique correspondant au tab selectionné ####
        # 
        Print(var)
        
        
        pattern_searched = paste0(c(&quot;gg_plot&quot;, &quot;gg_html&quot;), &quot;.rds&quot;, collapse = &quot;|&quot;)
        path_var = file.path(link_results, perim, var)
        
          list_file_var = file.path(path_var, list.files(path_var, pattern = pattern_searched))
          list_file_pdf = file.path(path_var, list.files(path_var, pattern = &quot;pdf&quot;))
        
          file_to_load = list_file_var[1]     
          
             # 
             # recherche du pdf correspondant au graphique ####
             # 
             if(length(list_file_pdf) &gt; 0){
               file_gg(list_file_pdf[1])
             }else{
               file_gg(NULL)
             }
          
             # 
             # chargement du graphique ####
             # 
          
             Print(file_to_load)
           
              gg = readRDS(file_to_load)
              
              gg_react[[var]] = gg
              current_plot(gg)
              
              var_ly = paste0(var, &quot;_ly&quot;)
              
              Print(input$interact_plot)
              
              get_interactive_plot = FALSE
              
              if(!is.null(input$interact_plot)){
                if(input$interact_plot == TRUE){
                  if(&quot;ggplot&quot; %in% class(gg)){
                    get_interactive_plot = TRUE
                  }
                }
              }
              if(get_interactive_plot == TRUE){
                
                gg_ly =  plotly::ggplotly(gg) %&gt;% 
                  layout(legend = list(orientation = &quot;h&quot;,   # show entries horizontally
                                       xanchor = &quot;center&quot;,  # use center of legend as anchor
                                       x = 0.5,
                                       yanchor = &quot;bottom&quot;,
                                       y = -0.6
                                       ))  
                # subtitle
                # if(!is.null(gg$labels$subtitle) &amp; !is.null(gg$labels$title)){
                  # subtitle_ly = paste0(gg$labels$title,
                  #                   &#39;&lt;br&gt;&#39;, &#39;&lt;sup&gt;&#39;,
                  #                   gsub(&quot;\\\n&quot;, &quot;&quot;, gg$labels$subtitle),
                  #                   &#39;&lt;/sup&gt;&#39;)
                  # subtitle_ly = paste0(gsub(&quot;\\\n&quot;, &quot;&quot;, gg$labels$subtitle))
                                    
                  # gg_ly = gg_ly %&gt;% 
                  #   layout(
                  #     # title = list(text = title_ly),
                  #     annotations=list(text = subtitle_ly,
                  #                      xref=&quot;paper&quot;,
                  #                      x=0.5,
                  #                      yanchor = &quot;bottom&quot;,
                  #                      y = -0.2,
                  #                      showarrow=FALSE)
                  #          )
                # }
                
                gg_react[[var_ly]] = gg_ly
              }else{
                gg_react[[var_ly]] = gg
              }
            
              Print(names(reactiveValuesToList(gg_react)))
              
              link_code_file_ = gg$link_code_file
              link_code_file_ = gsub(link_app, &quot;.&quot;, link_code_file_)
              
              var_name(var)
              link_code_file(link_code_file_)
              update_plot(gg$update)
              run_time_plot(gg$run_time)
         
              # 
              # mise a jour du graphique a l ecran 
              # 
              
              var_gg = paste0(var, &quot;_gg&quot;)
              var_ly_gg = paste0(var_ly, &quot;_gg&quot;)
              # output[[var_gg]] &lt;- renderPlot({gg_react[[var]]})
              
              # 
              # creation d&#39;un onglet/tab avec le graphique 
              # 
              Print(var)
             
              
              if(&quot;ggplot&quot; %in% class(gg)){
                
                Print(class(gg))
                output[[var_gg]] &lt;- renderPlot({gg_react[[var]]})
                
                output[[var_ly_gg]] &lt;- renderPlotly({gg_react[[var_ly]]})
                
                if(input$interact_plot == FALSE){
                  list_tab2[[length(list_tab2)+1]] = tabPanel(title = &quot;Graphique&quot;,
                                                              plotOutput(var_gg,
                                                                         width = &quot;100%&quot;
                                                                         , height = &quot;80vh&quot;
                                                              ))
                }else{
                  list_tab2[[length(list_tab2)+1]] = tabPanel(title = &quot;Graphique&quot;,
                                                              plotlyOutput(var_ly_gg,
                                                                           width = &quot;100%&quot;
                                                                           , height = &quot;80vh&quot;
                                                              ))
                }
                
              }else if(&quot;highchart&quot; %in% class(gg)){
                Print(class(gg))
                
                
                
                if(&quot;highcharter&quot; %in% pkg[,1]){
                  
                  output[[var_gg]] &lt;- renderHighchart({gg_react[[var]]})
                  
                  list_tab2[[length(list_tab2)+1]] = tabPanel(title = &quot;Graphique&quot;,
                                                              highchartOutput(var_gg,
                                                                              width = &quot;100%&quot;
                                                                              , height = &quot;80vh&quot;
                                                              ))
                }
               
                
              }
              
                list_file_code = file.path(path_var, list.files(path_var, pattern = &quot;code.html&quot;))
                page_code(list_file_code[1])
                
                Print(list_file_code)
                
                
                if(length(list_file_code) &gt; 0){
                  
                  code_file = list_file_code[1]
                  list_tab2[[length(list_tab2)+1]] = tabPanel(title = &quot;Code&quot;,
                                                              box(
                                                                width = &quot;100%&quot;,
                                                                includeHTML(list_file_code[1])
                                                              ))

                }
                
      }
      }
      
      list_tab2[[length(list_tab2)+1]] =
        tabPanel(title = &quot;Catalogue&quot;,
                 box(
                   width = &quot;100%&quot;, 
                   
                   DT::dataTableOutput(&quot;dico_home_page&quot;,
                                       width = &quot;100%&quot;
                                       , height = &quot;75vh&quot;
                   ) 
                   
                   ))
        
        output$list_tab &lt;- renderUI({
          do.call(tabsetPanel, c(list_tab2, id = &#39;tabs&#39;))
        })
      
      

      print(&quot;end  &quot;)

      })

  observe({
      # observeEvent(
      #   {input$downloadData},
      #   {
      Print(input$downloadData)
      
    # 
    # données pour le bouton téléchargement ####
    # 
    
      # 
      # recherche des donnees dans les graphs
      # emplacement peut varier en fonction du graphique
      # 
      
      gg = current_plot()
      
      if(&quot;ggplot&quot; %in% class(gg)){
        if(length(gg$data) != 0){
          data_current_plot &lt;- gg$data
        }else{
          if (length(gg$layers) &gt;= 2) {
            if (!is.null(gg$layers[[1]]$data) &amp; !is.null(gg$layers[[2]]$data)) {
              data_current_plot &lt;-
                plyr::rbind.fill(gg$layers[[1]]$data, gg$layers[[2]]$data)
              
            }
          }
        }
      }
      if(&quot;highchart&quot; %in% class(gg)){
        
        n_series = length(gg[[&quot;x&quot;]][[&quot;hc_opts&quot;]][[&quot;series&quot;]])
        if(n_series &gt; 0){
          serie_id = 1
          list_df = list()
          
          for(serie_id in 1:n_series){
            data_list = gg[[&quot;x&quot;]][[&quot;hc_opts&quot;]][[&quot;series&quot;]][[serie_id]][[&quot;data&quot;]]
            
            data_raw_hc = unlist(flatten(data_list))
            
            for(test_id in 2*1:(length(data_list)/2)){
              list_df[[length(list_df)+1]] = data.frame(time = data_raw_hc[test_id-1],
                                                        value = data_raw_hc[test_id],
                                                        series = serie_id)
            }
          }
          
          data_hc = bind_rows(list_df)
          
          data_hc = data_hc %&gt;% 
            mutate(time2 = as.POSIXct(time/1000, origin  = &quot;1970-01-01&quot;))
          
        }else{
          data_hc = data.frame()
        }
        data_current_plot = data_hc
      }
      
      if(exists(&quot;data_current_plot&quot;)){
        data_ = data_current_plot
      }else{
        data_ = NULL
      }
     
    
      if(!is.null(data_)){
        if(all(names(data_) %in% c(&quot;time&quot;, &quot;value&quot;, &quot;label&quot;))){
          data_ = data_ %&gt;% 
            tidyr::pivot_wider(names_from = &quot;label&quot;, values_from = &quot;value&quot;)
        }
      }
      
      if(exists(&quot;file_gg&quot;)){
        file_gg_ = file_gg()
      }else{
        file_gg_ = NULL
      }
      
      if(!is.null(data_)){
        if(any(class(data_) == &quot;data.frame&quot;)){
          output$downloadData &lt;- downloadHandler(
            filename = function() {
              if(!is.null(file_gg_)){
                file_gg_name = basename(file_gg_)
                paste(&quot;data_&quot;, gsub(&quot;.pdf&quot;,&quot;&quot;, file_gg_name),&quot;_&quot;, gsub(&quot;-|:| |CET&quot;,&quot;&quot;, Sys.time()), &quot;.xlsx&quot;, sep=&quot;&quot;)
              }else{
                paste(&quot;data_&quot;, gsub(&quot;-|:| |CET&quot;,&quot;&quot;, Sys.time()), &quot;.xslx&quot;, sep=&quot;&quot;)
              }
            },
            content = function(file) {
              openxlsx::write.xlsx(data_, file)
            }
          )
        }
      }
    
    
    # 
    # graphique pour le bouton téléchargement ####
    # 
    if(exists(&quot;file_gg&quot;)){
      if(!is.null(file_gg_)){
        file_gg_ = file_gg()
        
          output$downloadPlot &lt;- downloadHandler(
            filename = function() {
              file_gg_name = basename(file_gg_)
              paste(&quot;plot_&quot;, gsub(&quot;.pdf&quot;,&quot;&quot;, file_gg_name),&quot;_&quot;, gsub(&quot;-|:| |CET&quot;,&quot;&quot;, Sys.time()), &quot;.pdf&quot;, sep=&quot;&quot;)
            },
            content = function(file) {
              file.copy(file_gg_, file)
            }
          )
        
      }
    }
  })
  
  # 
  # création du cahier ####
  # 
  
  observe({
    list_graph_cahier = lapply(input$cahier, function(x) gg_react[[x]])
    
    output$downloadCahier &lt;- downloadHandler(
      filename = function() {
        paste(&quot;presentation_&quot;, gsub(&quot;-|:| |CET&quot;,&quot;&quot;, Sys.time()), &quot;.pdf&quot;, sep=&quot;&quot;)
      },
      content = function(file) {
        rmarkdown::render(input = cahier_file,
                          output_file = file,
                          params = list(list_graph = list_graph_cahier))
      }
    )
    
  })

}
)</code></pre>

