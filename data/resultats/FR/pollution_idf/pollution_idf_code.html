


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code>library(saqgetr)
library(tidyverse)
library(lubridate)
library(zoo)

time1 = Sys.time()

# DATA SOURCE : AIR BASE
# https://www.eea.europa.eu/data-and-maps/data/airbase-the-european-air-quality-database-7

# Import site information
data_sites &lt;- get_saq_sites()

data_sites_fr = data_sites %&gt;%
  filter(date_end &gt;= as.Date(&quot;2020-03-16&quot;)) %&gt;%
  filter(country_iso_code == &quot;FR&quot;) %&gt;%  
  filter(str_detect(eoi_code, &quot;^FR04&quot;)) 

data_sites_metada = data_sites %&gt;%
  select(site, site_name, country_iso_code, latitude, longitude, site_area, site_type) 

data_sites_city_id = data_sites_fr %&gt;% pull(site)

  data_all &lt;- get_saq_observations(
    site = data_sites_city_id, 
    start = 2020,
    verbose = TRUE
  )
  
  data_no2 = data_all %&gt;% 
    filter(variable == &quot;no2&quot;) %&gt;% 
    left_join(data_sites_metada, by = &quot;site&quot;) %&gt;% 
    filter(date &gt;= as.Date(&quot;2019-01-01&quot;))
  
date_confinement_ = as.POSIXct(c(&quot;2020-03-17 12:00:00&quot;,
                               &quot;2020-05-11 12:00:00&quot;))

date_confinement_ = as.Date(c(&quot;2020-03-17&quot;,
                                 &quot;2020-05-11&quot;))

list_site_selected = data_no2 %&gt;% distinct(site_name)

data_plot = data_no2 %&gt;% 
  filter(date &gt;= as.POSIXct(&quot;2019-12-01 00:00:00&quot;)) %&gt;% 
  mutate(jour = lubridate::date(date)) %&gt;% 
  filter(site_area != &quot;rural_regional&quot;) %&gt;% 
  filter(str_detect(site_name, &quot;PARIS|peripherique|Elysee|Saint-De|Opéra&quot;)) %&gt;% 
  group_by(jour, site_name) %&gt;% 
  summarise(value = mean(value, na.rm = TRUE)) %&gt;% 
  arrange(site_name) %&gt;% 
  group_by(site_name) %&gt;% 
  mutate(rollmean = rollmean(value, 7, na.pad = TRUE, align = &quot;center&quot;)) %&gt;% 
  filter(jour &gt;= as.Date(&quot;2020-01-01&quot;)) %&gt;%
  select(value, rollmean, site_name, jour) %&gt;% 
  pivot_longer(-c(&quot;jour&quot;, &quot;site_name&quot;), names_to = &quot;variable&quot;, values_to = &quot;value&quot;) %&gt;% 
  mutate(variable_label = case_when(variable == &quot;value&quot; ~ &quot;Moyenne journalière&quot;,
                                    variable == &quot;rollmean&quot; ~ &quot;Moyenne mobile centrée sur 7 jours&quot;)) %&gt;% 
  mutate(variable_label = factor(variable_label,
                                 levels = c(&quot;Moyenne mobile centrée sur 7 jours&quot;, &quot;Moyenne journalière&quot;)))

last_values_date = data_plot %&gt;% 
  ungroup() %&gt;% 
  filter(jour == max(jour)) %&gt;% 
  pull(jour) %&gt;% 
  max()

time_now = with_tz(now(), &quot;Europe/Paris&quot;)
comment_ = &quot;les lignes verticales correspondent à la période de confinement&quot;

titre = &quot;Pollution à Paris, concentration de NO2 dans l&#39;air&quot;
sous_titre = sprintf(&quot;Source: EEA Agence Européenne de l&#39;environnement/AirParif \nDernier point : %s, Fait le : %s,  Unité :%s\n%s&quot;,
                     last_values_date,  time_now, &quot;µg/m^3&quot;, comment_)

gg_pollution_idf =
ggplot(data_plot, aes(x = jour, y = value,
                      colour = variable_label, linetype = variable_label)) +
  facet_wrap(~site_name, scales = &quot;free_y&quot;) +
  geom_line(size = 0.8) +
  geom_vline(xintercept = date_confinement_, colour = &quot;black&quot;, linetype = &quot;dashed&quot;) +
  ggtitle(titre) +
  labs(subtitle = sous_titre) +
  ggthemes::theme_stata() +
  theme(
    plot.title   = element_text(lineheight = 0.8,
                                face = &quot;bold&quot;, hjust = 0.5, size = 16),
    axis.text.x  = element_text(angle = 0),
    axis.text.y  = element_text(angle = 0, hjust = 1),
    axis.title.x = element_blank(),
    text = element_text(size = 12),
    # axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;
  ) 

gg_pollution_idf

time2 = Sys.time()
run_time = as.numeric(difftime(time2, time1, units = &quot;secs&quot;))</code></pre>

