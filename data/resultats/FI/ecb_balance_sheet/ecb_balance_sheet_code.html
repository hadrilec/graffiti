


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code># lib_loc = &quot;N:/GDCJ/N-GDCJ/Echanges.DCJ/DSC/R/R-3.6.1/library&quot;
# .libPaths(&quot;N:/GDCJ/N-GDCJ/Echanges.DCJ/DSC/R/R-3.6.1/library&quot;)

#version of R &gt; 3.5

# library(shiny, lib.loc = lib_loc)
# library(shinydashboard, lib.loc = lib_loc)
# library(shinydashboardPlus, lib.loc = lib_loc)
# library(shinyWidgets, lib.loc = lib_loc)
# library(tidyr, lib.loc = lib_loc)
# library(lubridate, lib.loc = lib_loc)
# library(stringr, lib.loc = lib_loc)
# library(dplyr, lib.loc = lib_loc)

library(shiny)
library(shinydashboard)
library(shinydashboardPlus)
library(shinyWidgets)
# library(shinycssloaders)
library(shinyjs)
library(shinyflags)

library(eia)
library(tidyverse)

library(plotly)
library(rmarkdown)

# library(rhandsontable)
library(DT)
# library(lubridate)
library(fredr)
library(lubridate)
# library(magrittr)
library(stringr)
# library(dplyr)
library(ggthemes)
library(zoo)
# library(tidyr)

library(pdfetch)
library(RJSONIO)

# library(colorspace, lib.loc = lib_loc)
# library(RColorBrewer, lib.loc = lib_loc)

Print = function(x){print(deparse(substitute(x)));print(x)}

link_app =  &quot;N:/GDCJ/N-GDCJ/Echanges.DCJ/DSC/Rshiny boite a outils&quot;
# options(shiny.reactlog=TRUE)
# shiny::runApp(link_app, display.mode=&quot;showcase&quot;)
# setwd(link_app)
chemin_prev = &quot;&quot;
link_results =  &quot;./data/resultats&quot;


cahier_file = &quot;cahier.Rmd&quot;
rmd_file = &quot;read_code.Rmd&quot;
rmd_output_file  = &quot;read_code.html&quot;
 
# DB_var_file = file.path(&quot;.&quot;,&quot;resultats&quot;,&quot;_files&quot;, &quot;DB_variables.RData&quot;) 
DB_var_file = file.path(&quot;.&quot;,&quot;data&quot;,&quot;resultats&quot;,&quot;_files&quot;, &quot;DB_variables.rds&quot;)
# last_db_var_update =  file.info(DB_var_file)[1,&quot;mtime&quot;]
# last_db_var_update_min_date = last_db_var_update %m+% days(7)

# source(file.path(link_app, &quot;pRev_DB_var_names.R&quot;))
source(&quot;./pRev_DB_var_names.R&quot;)
# update_DB_variable()

# MAJ de la base de données des noms des variables toutes les heures
if(FALSE){
  if(Sys.time() &gt; last_db_var_update_min_date){
    update_DB_variable()
  }
}

# 
# API KEY POUR TOUS LES SCRIPTS
# 

# BANQUE DE FRANCE
webstat_client_ID &lt;- &#39;d85fb7da-a306-469f-9b60-2e35d251611b&#39;

# EIA agence americaine energie
api_key_data_gov_us = &quot;sudqWb4gHCNBIo00XXxrhkB1iSe6jRKod08vXyKc&quot;
api_key_eia = &quot;423b693a2da4d6e9f5b0a1957eff0ba8&quot;
eia_set_key(api_key_eia)

# Federal Reserve API key
fredr_set_key(&quot;1e1376b050a44076281adda2fe2e1a32&quot;)

# AQICN
api_token_aqicn = &quot;d2cec6e4da536c80809e27cfc169962408f18642&quot;

# Sys.setenv(http_proxy=&quot;proxy-rie.http.insee.fr:8080&quot;)
# Sys.setenv(https_proxy=&quot;proxy-rie.http.insee.fr:8080&quot;)

# DB_var_file = file.path(link_results, &quot;_files&quot;, &quot;variables_DB.RData&quot;)
# load(DB_var_file)
DB_variables = readRDS(DB_var_file)

# Print(DB_variables)

perimetre_list = DB_variables %&gt;% 
  pull(perim) %&gt;% 
  unique() %&gt;% 
  sort()

countries &lt;- c(&quot;FR&quot;, &quot;DE&quot;, &quot;UK&quot;, &quot;ES&quot;, &quot;IT&quot;, &quot;CN&quot;, &quot;JP&quot;, &quot;ZE&quot;, &quot;US&quot;, &quot;OIL&quot;, &quot;FI&quot;, &quot;COM&quot;, &quot;INF&quot;)
# countries &lt;- c(&quot;FR&quot;, &quot;DE&quot;, &quot;UK&quot;, &quot;ES&quot;, &quot;IT&quot;, &quot;CN&quot;, &quot;JP&quot;, &quot;ZE&quot;, &quot;US&quot;)

perimetre_added = which(!perimetre_list %in% countries)
if(length(perimetre_added) &gt; 0){
  countries = c(countries, perimetre_list[perimetre_added])
}

link_flags = &quot;https://cdn.rawgit.com/lipis/flag-icon-css/master/flags/4x3&quot;

flags &lt;- c(&quot;fr.svg&quot;, &quot;de.svg&quot;, &quot;gb.svg&quot;, &quot;es.svg&quot;, &quot;it.svg&quot;,
           &quot;cn.svg&quot;, &quot;jp.svg&quot;, &quot;eu.svg&quot;, &quot;us.svg&quot;)

# flags_names = c(gsub(&quot;.svg&quot;, &quot;&quot;, flags))

flags_id_list = c(&quot;fr&quot;, &quot;de&quot;, &quot;gb&quot;, &quot;es&quot;, &quot;it&quot;,
                         &quot;cn&quot;, &quot;jp&quot;, &quot;eu&quot;, &quot;us&quot;)

flags_label_list = c(&quot;France&quot;, &quot;Allemagne&quot;, &quot;Royaume-Uni&quot;, &quot;Espagne&quot;, &quot;Italie&quot;,
                  &quot;Chine&quot;, &quot;Japon&quot;, &quot;Zone Euro&quot;, &quot;Etats-Unis&quot;)

icons_perims = list()

for(pays in 1:length(flags_id_list)){
  pays_name_id = flags_id_list[pays]
  pays_name_label = flags_label_list[pays]
  icons_perims[[length(icons_perims)+1]] = paste(flag(pays_name_id, size = 15), &quot; &quot;, pays_name_label)
}
icons_perims = unlist(icons_perims)

icons_perims = c(icons_perims,
                 paste(as.character(icon(&quot;gas-pump&quot;)), &quot; &quot; ,&quot;Pétrole&quot;),
                 paste(as.character(icon(&quot;money-check-alt&quot;)), &quot; &quot; ,&quot;Finance&quot;),
                       paste(as.character(icon(&quot;globe-americas&quot;)), &quot; &quot; ,&quot;Commerce&quot;),
                 paste(as.character(icon(&quot;shopping-cart&quot;)), &quot; &quot; ,&quot;Inflation&quot;))




# output$dico_home_page &lt;- DT::renderDT(dico_table,
#                                       filter = &quot;top&quot;)

# 
# 
dico_table = DB_variables %&gt;%
  select(perim, var, title) %&gt;%
  dplyr::rename(`Périmètre` = perim,
                Variable = var,
                Titre = title)
# 
# dico_home_page &lt;- renderDataTable(dico_table,
#                                         filter = &quot;top&quot;)

# gg = readRDS(&quot;./data/resultats/ZE/population_europe/population_europe_gg_plot.rds&quot;)

# plot_ex = plotly::ggplotly(gg)

# flag(&quot;fr&quot;)


# create_code_html = TRUE

export_graph = function (plot, folder_name, perim = &quot;_autre&quot;, run_time = NULL, 
                         rmd_file = &quot;./read_code.Rmd&quot;, create_code_html = FALSE,
                         width = 15, height = 10, update = FALSE) 
{
  if (missing(folder_name)) {
    folder_name = deparse(substitute(plot))
  }
  if (!any(class(plot) == &quot;ggplot&quot;)) {
    cat(&quot;plot doit etre un graphique de class ggplot&quot;)
    stop()
  }
  error_message = FALSE
  if (exists(&quot;chemin_prev&quot;)) {
    path_resultats = file.path(&quot;.&quot;, &quot;data&quot;,&quot;resultats&quot;)
    if (!file.exists(path_resultats)) {
      dir.create(path_resultats, &quot;0777&quot;)
    }
  }else {
    error_message = TRUE
  }
  if (error_message) {
    text1 = &quot;creer une variable globale chemin_prev contenant le lien vers le dossier ou exporter les resultats, exemple : &quot;
    text2 = &quot;N:/G140/M-G140/Usuels.dsc/pRev&quot;
    error_message_text = sprintf(&quot;%s \n%s&quot;, text1, 
                                 text2)
    cat(error_message_text)
    stop()
  }
  path_resultats_perim = file.path(&quot;.&quot;,&quot;data&quot;, &quot;resultats&quot;, 
                                   perim)
  path_resultats_perim_folder = file.path(&quot;.&quot;,&quot;data&quot;, &quot;resultats&quot;, 
                                          perim, folder_name)
  for (link in c(path_resultats_perim, path_resultats_perim_folder)) {
    if (!file.exists(link)) {
      dir.create(link, &quot;0777&quot;)
    }
  }
  file_name = paste0(folder_name, &quot;_gg_plot.rds&quot;)
  # file_name = paste0(folder_name, &quot;_gg_plot.RData&quot;)
  file_name_pdf = paste0(folder_name, &quot;_gg_plot.pdf&quot;)
  file_path = file.path(path_resultats_perim_folder, file_name)
  file_path_pdf = file.path(path_resultats_perim_folder, file_name_pdf)
  timenow = gsub(&quot;-| |:|CET&quot;, &quot;&quot;, Sys.time())
  # if (file.exists(file_path_pdf)) {
  #   if (file.opened(file_path_pdf)) {
  #     file_path_pdf = file.path(path_resultats_perim_folder, 
  #                               paste0(folder_name, &quot;_&quot;, timenow, &quot;_gg_plot.pdf&quot;))
  #   }
  # }
  
  link_used_file = &quot;&quot;
  link_used_file &lt;- try(rstudioapi::getSourceEditorContext()$path)
  if (class(link_used_file) == &quot;try-error&quot;) {
    link_used_file = &quot;&quot;
  }
  
  # change_link_file = FALSE
  # if (is.null(link_used_file)) {
  #   change_link_file = TRUE
  # }
  # if (exists(&quot;chemin_prev&quot;)) {
  #   if (!str_detect(link_used_file, chemin_prev)) {
  #     change_link_file = TRUE
  #   }
  # }

      if (file.exists(file_path)) {
        gg = readRDS(file_path)
        if (!is.null(gg$link_code_file)) {
          if(gg$link_code_file != &quot;&quot;){
            if (!str_detect(gg$link_code_file, &quot;server&quot;)) {
              link_used_file &lt;- gg$link_code_file
            }
          }
        }
      }
  
  # 
  # html code file creation
  # 
  file_name_html = paste0(folder_name, &quot;_code.html&quot;)
  rmd_output_file = file.path(path_resultats_perim_folder, file_name_html)
  
  code_file = link_used_file
  
  if(create_code_html){
    rmarkdown::render(input = rmd_file,
                      runtime = &quot;shiny&quot;,
                      output_file = rmd_output_file,
                      params = list(code_file = link_used_file))
  }
  
  plot + ggsave(file_path_pdf, width = width, height = height)
  plot$update &lt;- update
  plot$link_code_file &lt;- link_used_file
  plot$run_time &lt;- run_time
  gg = plot
  # save(gg, file = file_path)
  saveRDS(gg, file = file_path)
}



readSDMX2 &lt;- function(link, name = &quot;dfSDMX&quot;){
  
  tfile &lt;- tempfile()
  on.exit(unlink(tfile))
  options(warn = -1)
  dwn = try(utils::download.file(link, tfile, mode = &quot;wb&quot;, quiet = TRUE), silent = TRUE)
  
  if(class(dwn) != &quot;try-error&quot;){
    sdmx &lt;- rsdmx::readSDMX(tfile, isURL = FALSE)
    df &lt;- as.data.frame(sdmx)
    return(df)
  }else if(stringr::str_detect(link, &quot;insee&quot;)){
    options(warn = 1)
    warning(&quot;backup solution&quot;)
    series_plus = basename(link)
    list_series = stringr::str_split(series_plus, pattern = &quot;\\+&quot;)[[1]]
    list_df = list()
    for(series in list_series){
      df = data.frame(pdfetch::pdfetch_INSEE(series))
      names(df) = &quot;value&quot;
      df[,&quot;obsTime&quot;] = rownames(df)
      df[,&quot;idbank&quot;] = series
      rownames(df) = NULL
      link2 = sprintf(&quot;https://www.insee.fr/en/statistiques/serie/ajax/%s&quot;, series)
      metadata = RJSONIO::fromJSON(link2)
      df[,&quot;TITLE_FR&quot;] = metadata[[&quot;series&quot;]][[1]][[&quot;titreFR&quot;]]
      df[,&quot;TITLE_EN&quot;] = metadata[[&quot;series&quot;]][[1]][[&quot;titreEN&quot;]]
      df[,&quot;freq&quot;] = metadata[[&quot;series&quot;]][[1]][[&quot;frequence&quot;]]
      df[,&quot;lastUpdate&quot;] = metadata[[&quot;series&quot;]][[1]][[&quot;lastUpdate&quot;]]
      df[,&quot;unit&quot;] = metadata[[&quot;series&quot;]][[1]][[&quot;uniteMesure&quot;]]
      list_df[[length(list_df)+1]] = df
    }
    data = dplyr::bind_rows(list_df)
    return(data)
  }else{
    return(NULL)
  }
}</code></pre>

