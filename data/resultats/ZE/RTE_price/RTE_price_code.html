


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code># library(tidyverse)
library(dplyr)
library(stringr)
library(xml2)
library(rvest)
library(XML)
library(purrr)
library(lubridate)
library(ggplot2)

time1 = Sys.time()

# 
# REQUETE SUR ECO2MIX POUR OBTENIR LES CHIFFRES :
# https://www.rte-france.com/en/eco2mix/donnees-de-marche-en

link_data = &quot;./data/resultats/ZE&quot;
dir.create(file.path(link_data, &quot;RTE_price&quot;))
dir.create(file.path(link_data, &quot;RTE_price&quot;, &quot;data&quot;))

link_envir_RTE_price_ = file.path(link_data, &quot;RTE_price&quot;, &quot;data&quot;)

# link_envir_RTE_price_ = file.path(&quot;D:/XLAPDO&quot;, &quot;RTE_price&quot;)

get_RTE_price = function(target_date_start,
                         target_date_end,
                         link_envir_RTE_price = link_envir_RTE_price_ ){
  
  
  target_date = target_date_start
  year = substr(target_date, 1, 4)
  month = substr(target_date, 6, 7)
  day = substr(target_date, 9, 10)
  target_date2 = paste(day, month, year, sep = &quot;/&quot;)
  
  year_end = substr(target_date_end, 1, 4)
  month_end = substr(target_date_end, 6, 7)
  day_end = substr(target_date_end, 9, 10)
  target_date_end2 = paste(day_end, month_end, year_end, sep = &quot;/&quot;)
  
  # url = &quot;https://www.rte-france.com/getEco2MixXml.php?type=donneesMarche&amp;&amp;dateDeb=05/02/2020&amp;dateFin=05/02/2020&amp;mode=NORM&quot;
  
  url = sprintf(&quot;https://www.rte-france.com/getEco2MixXml.php?type=donneesMarche&amp;&amp;dateDeb=%s&amp;dateFin=%s&amp;mode=NORM&quot;,
                target_date2, target_date_end2)
  
  price_data_file = file.path(link_envir_RTE_price, sprintf(&quot;RTE_price_%s_%s.xml&quot;, target_date, target_date_end))
  if(!file.exists(price_data_file)){
    download.file(url, price_data_file, mode = &quot;wb&quot;)
  }
  
  print(price_data_file)
  # df = xml2::read_xml(t_file)
  df = try(xml2::read_xml(price_data_file), silent = TRUE)
  
  list_df = list()
  
  i = 6
  data = try(xml2::xml_child(df, i), silent = T)
  data = xml2::as_list(data)
  
  while(class(data) != &quot;try-error&quot;){
    
    data = try(xml_child(df, i), silent = T)
    
    if(class(data) != &quot;try-error&quot;){
      
      date_found = gsub(&#39;&quot;&#39;, &quot;&quot;, gsub(&quot;&lt;donneesMarche date=|&gt;&quot;, &quot;&quot;, format(data)))
      data = as_list(data)
      
      # data = xml_child(df, 6)
      # data = as_list(data)
      
      list_id_areas = which(names(data) == &quot;type&quot;)
      
      for(id in list_id_areas){
        perim = attr(data[[id]], &quot;perimetre&quot;)
        n = length(data[[id]])
        for(hour in 1:n){
          values = data.frame(perim = perim,
                              value = as.numeric(data[[id]][[hour]][[1]]),
                              date = date_found,
                              hour = attr(data[[id]][[hour]], &quot;periode&quot;))
          
          list_df[[length(list_df)+1]] = values
        } 
      }
    }
    i = i + 1
  }
  
  RTE_price = bind_rows(list_df)
  return(RTE_price)
}
today_date = today()
last_year_date = as.Date(gsub(year(today_date), year(today_date)-1, today_date))

RTE_price_mars19 = get_RTE_price(as.Date(&quot;2019-03-01&quot;), as.Date(&quot;2019-03-31&quot;))
RTE_price_avril19 = get_RTE_price(as.Date(&quot;2019-04-01&quot;), as.Date(&quot;2019-04-30&quot;))
# RTE_price_mai19 = get_RTE_price(as.Date(&quot;2019-05-01&quot;), as.Date(&quot;2019-05-31&quot;))
RTE_price_today19 = get_RTE_price(as.Date(&quot;2019-05-01&quot;), last_year_date)


RTE_price_mars20 = get_RTE_price(as.Date(&quot;2020-03-01&quot;), as.Date(&quot;2020-03-31&quot;))
RTE_price_avril20 = get_RTE_price(as.Date(&quot;2020-04-01&quot;), as.Date(&quot;2020-04-30&quot;))
# RTE_price_mai20 = get_RTE_price(as.Date(&quot;2020-05-01&quot;), as.Date(&quot;2020-05-31&quot;))
RTE_price_today20 = get_RTE_price(as.Date(&quot;2020-05-01&quot;), today_date)


RTE_price = bind_rows(RTE_price_mars19, RTE_price_mars20,
                      RTE_price_avril19, RTE_price_avril20,
                      RTE_price_today19, RTE_price_today20)

RTE_price_ = RTE_price %&gt;% 
  mutate(hour_ = case_when(nchar(hour) == 1 ~ paste0(&quot;0&quot;, hour), TRUE ~ as.character(hour))) %&gt;% 
  mutate(day = day(date)) %&gt;% 
  mutate(year = year(date)) %&gt;% 
  mutate(year_ = as.character(year)) %&gt;% 
  mutate(month = month(date)) %&gt;% 
  mutate(day_ = case_when(nchar(day) == 1 ~ paste0(&quot;0&quot;, day), TRUE ~ as.character(day))) %&gt;%
  mutate(month_ = case_when(nchar(month) == 1 ~ paste0(&quot;0&quot;, month), TRUE ~ as.character(month))) %&gt;%
  mutate(time = as_datetime(paste(date, paste0(hour_, &quot;:00:00&quot;)))) %&gt;% 
  mutate(time_ = as_datetime(paste(sprintf(&quot;2020-%s-%s&quot;, month_, day_), paste0(hour_, &quot;:00:00&quot;)))) %&gt;% 
  filter(time_ &lt; today()) %&gt;%
  filter(!perim %in% c(&quot;DE&quot;, &quot;CH&quot;)) %&gt;% 
  mutate(perim = replace(perim, perim == &quot;DL&quot;, &quot;DE&quot;))

confin_dates = data.frame(perim = c(&quot;FR&quot;, &quot;GB&quot;, &quot;IT&quot;, 
                                    # &quot;IT&quot;,
                                    &quot;ES&quot;, &quot;BE&quot;, &quot;DE&quot;),
                          time_ = c(as_datetime(&quot;2020-03-17 12:00:00&quot;),
                                    as_datetime(&quot;2020-03-23 12:00:00&quot;),
                                    as_datetime(&quot;2020-03-09 20:00:00&quot;), #all country
                                    # as_datetime(&quot;2020-03-08 20:00:00&quot;), #northern part
                                    as_datetime(&quot;2020-03-14 08:00:00&quot;),
                                    as_datetime(&quot;2020-03-18 12:00:00&quot;),
                                    as_datetime(&quot;2020-03-22 12:00:00&quot;)
                                    ))

time_now = with_tz(now(), &quot;Europe/Paris&quot;)

last_point_date = RTE_price_ %&gt;% pull(time) %&gt;% max()
last_point = sprintf(&quot;Dernier point : %s\nFait le : %s&quot;, last_point_date, time_now)
comment = &quot;les lignes verticales correspondent à la date de début de confinement sur l&#39;ensemble du territoire&quot;

gg_RTE_price = 
ggplot(RTE_price_, aes(x = time_, y = value, colour = year_)) +
  geom_line(size = 1) +
  geom_vline(data = confin_dates, aes(xintercept = time_), linetype = &quot;dashed&quot;) +
  facet_wrap(~perim) +
  ggtitle(&quot;Prix spot de l&#39;éctricité en euros du Mwh sur le marché EPEX&quot;) +
  labs(subtitle = sprintf(&quot;Source : RTE, données disponibles heure par heure\n %s\n%s&quot;, comment, last_point)) +
  ggthemes::theme_stata() +
  theme(
    plot.title   = element_text(lineheight = 0.8, face = &quot;bold&quot;, hjust = 0.5, size = 18),
    axis.text.x  = element_text(angle = 45, hjust = 1),
    axis.text.y  = element_text(angle = 0, hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;,
    legend.box = &quot;horizontal&quot;
  ) 

time2 = Sys.time()
run_time = as.numeric(difftime(time2, time1, units = &quot;secs&quot;))

export_graph(gg_RTE_price, perim = &quot;ZE&quot;,
             create_code_html = T,
             run_time = run_time,
             folder_name = &quot;RTE_price&quot;, update = T)</code></pre>

