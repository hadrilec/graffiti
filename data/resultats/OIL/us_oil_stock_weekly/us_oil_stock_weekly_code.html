


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code>library(eia)
library(tidyverse)
library(ggplot2)
library(lubridate)

time_start = Sys.time()

monthweeks &lt;- function(x) {
  UseMethod(&quot;monthweeks&quot;)
}
monthweeks.Date &lt;- function(x) {
  ceiling(as.numeric(format(x, &quot;%d&quot;)) / 7)
}

group_mean_years = 2011:2014
# group_mean_years2 = 2016:2018
group_mean_years2 = 0

# 
# TROUVER UNE SERIE PARMI CELLES DISPONIBLES
# 

# series = eia_cats()
# series_oil = eia_child_cats(714755)
# series_oil_stocks = eia_child_cats(714802)
# series_oil_stocks_type = eia_child_cats(388426)
# series_oil_stocks_type2 = eia_child_cats(395534)
# series_oil_stocks_type2_tot = eia_child_cats(395535)
# series_oil_stocks_type2_tot_product = eia_child_cats(395885)
# series_crude_oil_stock = eia_child_cats(395886)
# 
# series_tot_stock = eia_child_cats(387912)
# series_tot_stock_product = eia_child_cats(388153)

# PET.MCESTUS1.M
# U.S. Ending Stocks excluding SPR of Crude Oil, Monthly

# U.S. Ending Stocks excluding SPR of Crude Oil, Weekly
# PET.WCESTUS1.W

month_list = gsub(&quot;\\\\.&quot;,&quot;&quot;, month(1:12, label = T))
week_list = unlist(lapply(month_list, function(x){paste(x, 1:5)}))

# 
# TELECHARGEMENT ET TRAITEMENY DES DONNEES ####
# 

PET.WCESTUS1.W = eia_series(&quot;PET.WCESTUS1.W&quot;)

PET.WCESTUS1.W_data = data.frame(PET.WCESTUS1.W$data, stringsAsFactors = F) %&gt;% 
  mutate(date_ = as.Date(paste0(&quot;2020-&quot;,week, &quot;-1&quot;), &quot;%Y-%U-%u&quot;)) %&gt;% 
  filter(year &gt;= 2011) %&gt;% 
  mutate(year_ = case_when(year %in% group_mean_years ~
                             sprintf(&quot;%s-%s&quot;, min(group_mean_years), max(group_mean_years)),
                           year %in% group_mean_years2 ~
                             sprintf(&quot;%s-%s&quot;, min(group_mean_years2), max(group_mean_years2)),
                           TRUE ~ as.character(year))) %&gt;% 
  mutate(year_ = factor(year_)) %&gt;% 
  group_by(year_, date_, week) %&gt;% 
  summarise(mean_ = mean(value, na.rm = TRUE) / 1000) %&gt;% 
  mutate(month_week = monthweeks(date_)) %&gt;% 
  mutate(month_ = gsub(&quot;\\\\.&quot;, &quot;&quot;, month(date_, label = T))) %&gt;% 
  mutate(date2 = paste(month_, month_week)) %&gt;% 
  mutate(date2 = factor(date2, levels = week_list)) %&gt;% 
  drop_na()
  
# weeks = seq(from = 1, to = 60, by = 4)

xaxis_breaks = PET.WCESTUS1.W_data %&gt;% 
  filter(month_week %in% 1) %&gt;% 
  drop_na() %&gt;% 
  pull(date2) %&gt;% 
  unique()

# 
# CREATION DU GRAPHIQUE ####
# 

last_value = PET.WCESTUS1.W_data %&gt;% 
  ungroup() %&gt;% 
  mutate(year_ = as.numeric(as.character(year_))) %&gt;% 
  filter(year_ == max(year_, na.rm = T)) %&gt;% 
  filter(week == max(week)) %&gt;% 
  as.data.frame()

time_now = with_tz(now(), &quot;Europe/Paris&quot;)

subtitle_unit = &quot;Unité : millions de barils de pétrole&quot;
subtitle_source = &quot;Source: Energy Information Agency EIA&quot;
substitle_last_value = sprintf(&quot;Dernier point : %s semaine %s, stock : %s\n Fait le :%s&quot;,
                               last_value[1,&quot;month_&quot;],
                               last_value[1,&quot;month_week&quot;],
                               round(last_value[1,&quot;mean_&quot;]),
                               time_now)

gg_us_stock_oil_weekly =
ggplot(PET.WCESTUS1.W_data, aes(x = date2, y = mean_, colour = year_, group = year_)) +
  geom_line(size = 1) +
  ggthemes::theme_stata() +
  ggtitle(&quot;Stocks commerciaux de pétrole brut aux Etats-Unis&quot;) +
  labs(subtitle = sprintf(&quot;%s\n%s\n%s&quot;, subtitle_unit, subtitle_source, substitle_last_value)) +
  scale_y_continuous(sec.axis = dup_axis()) +
  scale_x_discrete(breaks = xaxis_breaks, expand = c(0.01, 0.01)) +
  theme(
    plot.title   = element_text(lineheight = 0.8, face = &quot;bold&quot;, hjust = 0.5, size = 18),
    axis.text.x  = element_text(angle = 45, hjust = 1),
    axis.text.y  = element_text(angle = 0, hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;
  ) 


time_end = Sys.time()
run_time = round(difftime(time_end, time_start, units = &quot;secs&quot;))


export_graph(
  gg_us_stock_oil_weekly,
  perim = &quot;OIL&quot;,
  folder_name = &quot;us_oil_stock_weekly&quot;,
  update = TRUE,
  create_code_html = TRUE,
  run_time = run_time
)</code></pre>

