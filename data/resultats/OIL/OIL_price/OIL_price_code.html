


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code>library(rdbnomics)
library(rsdmx)
library(ggthemes)
library(grid)
library(lubridate)
library(eurostat)
library(fredr)
library(dplyr)
library(ggplot2)
library(tidyverse)

start_time = today() %m-% months(12)
runtime_start = Sys.time()

date = gsub(&quot;-&quot;,&quot;&quot;,Sys.Date())

# Crude Oil Prices: West Texas Intermediate (WTI) - Cushing, Oklahoma (DCOILWTICO)
oil_us = fredr(series_id = &quot;DCOILWTICO&quot;)

# Crude Oil Prices: Brent - Europe (DCOILBRENTEU)
oil_eu = fredr(series_id = &quot;DCOILBRENTEU&quot;)


oil = rbind(oil_us, oil_eu)

oil = oil %&gt;%
  mutate(name = case_when(series_id == &quot;DCOILWTICO&quot; ~ &quot;WTI Texas&quot;,
                          series_id == &quot;DCOILBRENTEU&quot; ~ &quot;Brent Europe&quot;)) %&gt;% 
  mutate(name1 = name) %&gt;% 
  # mutate(name = paste(name, &quot;- dollars&quot;)) %&gt;% 
  dplyr::filter(date &gt;= &quot;2001-01-01&quot;) %&gt;% 
  mutate(currency = &quot;dollar&quot;)

link = &#39;https://api.db.nomics.world/v22/series/BDF/EXR/EXR.D.USD.EUR.SP00.A?observations=1&#39;
eur_usd &lt;- rdbnomics::rdb_by_api_link(link) %&gt;%
  mutate(type = &quot;Dollar américain&quot;, label = &quot;DOLLAR / EURO&quot;) %&gt;%
  drop_na() %&gt;% 
  mutate(eur_dollar = 1/value) %&gt;% 
  dplyr::select(period, eur_dollar) %&gt;% 
  dplyr::rename(date = period)

oil_eur = oil %&gt;% 
  left_join(eur_usd) %&gt;% 
  mutate(value_eur = value * eur_dollar) %&gt;% 
  mutate(name1 = name) %&gt;% 
  mutate(name = paste(name, &quot;- euros&quot;)) %&gt;% 
  dplyr::select(date, series_id, value_eur, name, name1) %&gt;% 
  dplyr::rename(value = value_eur) %&gt;% 
  dplyr::mutate(currency = &quot;euro&quot;)

oil_ = oil %&gt;% bind_rows(oil_eur)
  
max_oil_us = oil_us %&gt;%
  arrange(desc(date)) %&gt;%
  slice(1:3) %&gt;%
  mutate(month = month(date, label = T, abbr = T)) %&gt;%
  mutate(month = gsub(&quot;\\\\.&quot;,&quot;&quot;, month)) %&gt;%
  mutate(value = round(value,1))

max_oil_eu = oil_eu %&gt;%
  arrange(desc(date)) %&gt;%
  slice(1:3) %&gt;%
  mutate(month = month(date, label = T, abbr = T)) %&gt;%
  mutate(month = gsub(&quot;\\\\.&quot;,&quot;&quot;, month)) %&gt;%
  mutate(value = round(value,1))

year_value = year(today())
last_month_value = month(today() %m-% months(1))

avg_last_month = 
  oil_ %&gt;% 
  mutate(month_ = month(date)) %&gt;% 
  mutate(month_abb = month(date, label = TRUE)) %&gt;% 
  mutate(year_ = year(date)) %&gt;% 
  filter(year_ == year_value &amp; month_ == last_month_value) %&gt;% 
  filter(str_detect(name, &quot;Brent&quot;)) %&gt;% 
  group_by(name, month_, year_, month_abb, currency) %&gt;% 
  summarise(value = mean(value, na.rm = TRUE)) %&gt;% 
  mutate(month_label = gsub(&quot;\\\\.&quot;, &quot;&quot;, month_abb))

year_current = avg_last_month %&gt;% 
  pull(year_) %&gt;% unique()

month_current = avg_last_month %&gt;% 
  pull(month_label) %&gt;% unique()

euro_brent_last_month = avg_last_month %&gt;% 
  filter(currency == &quot;euro&quot;) %&gt;% 
  pull(value) %&gt;% 
  round(1)

dollar_brent_last_month = avg_last_month %&gt;% 
  filter(currency == &quot;dollar&quot;) %&gt;% 
  pull(value) %&gt;% 
  round(1)

last_month_value_brent = sprintf(&quot;Brent %s %s : %s$ %s€&quot;,
                                 year_current, month_current,
                                 dollar_brent_last_month, euro_brent_last_month)

subtitle_day = lubridate::day(max(oil$date))
subtitle_month = gsub(&quot;\\\\.&quot;,&quot;&quot;,
                      lubridate::month(max(oil$date), label = TRUE))
subtitle_year = lubridate::year(max(oil$date)) 
xaxis_breaks = seq.Date(from = min(oil$date), to = max(oil$date), by = &quot;1 months&quot;)

graph_subtitle_bond = sprintf(&quot;Texas: %s, Brent: %s, Unité : $/baril \n source : Agence américaine d&#39;information sur l&#39;énergie EIA&quot;,
                               max_oil_us[1,&quot;value&quot;],
                               max_oil_eu[1,&quot;value&quot;])

time_now = with_tz(now(), &quot;Europe/Paris&quot;)

graph_subtitle = sprintf(&quot;Dernier point : %s %s %s, Fait le : %s \n %s\n%s&quot;,
                         subtitle_day, subtitle_month, subtitle_year, time_now,
                         graph_subtitle_bond, last_month_value_brent)
coeff = 10
yaxis_breaks = seq(from = floor(min(oil$value, na.rm = TRUE) / coeff) * coeff,
                   to = ceiling(max(oil$value, na.rm = TRUE)/ coeff) * coeff, by = coeff)
# scale_y_continuous(sec.axis = dup_axis(), breaks = yaxis_breaks, labels = function(x) paste0(x, &quot;%&quot;)) +


oil_2 = oil_ %&gt;%
  filter(date &gt; &quot;2020-01-01&quot;) %&gt;%
  # filter(str_detect(name, &quot;Brent&quot;)) %&gt;% 
  drop_na() %&gt;% 
  filter(value != 0)

graph_oil = 
  ggplot(data = oil_2, aes(x = date, y = value, colour = name )) +
  geom_line(size = 1) +
  facet_grid(name1~currency) +
  ggtitle(&quot;Prix du pétrole&quot;) +
  labs(subtitle = graph_subtitle) + 
  scale_y_continuous(sec.axis = dup_axis(), breaks = yaxis_breaks) +
  scale_x_date(breaks = xaxis_breaks, date_labels = &quot;%b %y&quot;, expand = c(0.01, 0.01)) +
  theme_stata() +
  theme(
    plot.title   = element_text(lineheight = 0.8, face = &quot;bold&quot;, hjust = 0.5, size = 18),
    axis.text.x  = element_text(angle = 45, hjust = 1),
    axis.text.y  = element_text(angle = 0, hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;
  ) 

runtime_end = Sys.time()
run_time = as.numeric(difftime(runtime_end, runtime_start), units = &quot;secs&quot;)


export_graph(graph_oil, perim = &quot;OIL&quot;, run_time = run_time,
             create_code_html = TRUE,
             folder_name = &quot;OIL_price&quot;, update = TRUE)</code></pre>

