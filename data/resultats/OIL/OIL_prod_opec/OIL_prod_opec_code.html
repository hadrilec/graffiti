


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code># install.packages(&quot;eia&quot;)

library(eia)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(pRev)
library(RColorBrewer)


time_start = Sys.time()

# 
# TROUVER UNE SERIE PARMI CELLES DISPONIBLES
# 
# 
# series = eia_cats()
# series_oil = eia_child_cats(714755)
# series_oil_stocks = eia_child_cats(714802)
# series_oil_stocks_type = eia_child_cats(388426)
# series_oil_stocks_type2 = eia_child_cats(395534)
# series_oil_stocks_type2_tot = eia_child_cats(395535)
# series_oil_stocks_type2_tot_product = eia_child_cats(395885)
# series_crude_oil_stock = eia_child_cats(395886)
# 
# series_nrj_outlook = eia_child_cats(829714)
# series_world_oil = eia_child_cats(829716)
# series_world_supply = eia_child_cats(829746)

series_world_opec = eia_cats(1039874)
# series_world_non_opec = eia_cats(829751)

series_world_opec_df = series_world_opec[[&quot;childseries&quot;]] %&gt;% 
  filter(str_detect(name, &quot;Crude Oil Production&quot;) &amp; str_detect(name, &quot;Monthly&quot;))

series_download_opec = series_world_opec_df %&gt;% pull(series_id)

data = eia_series(series_download_opec)

list_df = list()

for(i in 1:nrow(data)){
  df = data$data[[i]]
  df[,&quot;series_id&quot;] = data[i,&quot;series_id&quot;]
  df[,&quot;name&quot;] = data[i,&quot;name&quot;]
  list_df[[length(list_df)+1]] = df
}

OIL_prod_opec = bind_rows(list_df) %&gt;% 
  mutate(type = &quot;OPEC&quot;) %&gt;% 
  filter(!str_detect(name, &quot;Total&quot;)) %&gt;% 
  mutate(country = gsub(&quot;Crude Oil Production|Monthly|,&quot;,&quot;&quot;, name))

country_order_df = OIL_prod_opec %&gt;% 
  group_by(country) %&gt;% 
  filter(date == max(date)) %&gt;% 
  arrange(desc(value)) 

country_order = country_order_df %&gt;% pull(country)
last_date = country_order_df %&gt;% pull(date) %&gt;% min()

OIL_prod_opec = OIL_prod_opec %&gt;% 
  mutate(country = factor(country, levels = country_order))

mycolors = c(brewer.pal(7, &quot;Set1&quot;), brewer.pal(8, &quot;Set2&quot;), brewer.pal(8, &quot;Set3&quot;))

time_now = with_tz(now(), &quot;Europe/Paris&quot;)

gg_OIL_prod_opec = 
ggplot(OIL_prod_opec, aes(x = date, y = value, fill = country)) +
  geom_area() +
  scale_y_continuous(sec.axis = dup_axis()) +
  scale_x_date(expand = c(0.01, 0.01)) +
  scale_fill_manual(values = mycolors) +
  ggtitle(&quot;Production de pétrole brut par les pays de l&#39;OPEP&quot;) +
  labs(subtitle = sprintf(&quot;Unité : millions de barils de pétrole par jour\n Source : EIA, Dernier point : %s, Fait le : %s&quot;,
                          last_date, time_now)) +
  ggthemes::theme_stata() +
  theme(
    plot.title   = element_text(lineheight = 0.8, face = &quot;bold&quot;,
                                hjust = 0.5, size = 18),
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 12),
    axis.text.y  = element_text(angle = 0, hjust = 1, size = 12),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.text = element_text(size = 10),
    legend.title = element_blank(),
    legend.position = &quot;bottom&quot;
  ) +
  guides(fill=guide_legend(nrow=2,byrow=TRUE)) 

time_end = Sys.time()
run_time = round(difftime(time_end, time_start, units = &quot;secs&quot;))

export_graph(gg_OIL_prod_opec,
             folder_name = &quot;OIL_prod_opec&quot;,
             create_code_html = TRUE,
             perim = &quot;OIL&quot;,
             update = TRUE, run_time = run_time)</code></pre>

