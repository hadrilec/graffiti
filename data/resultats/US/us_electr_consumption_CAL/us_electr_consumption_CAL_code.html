


<style type="text/css">
pre {
  max-height: 450px;
  overflow-y: auto;
}

pre[class] {
  max-height: 450px;
}
</style>
<pre class="r"><code>time_start = Sys.time()

electr_ = eia_child_cats(2122628)
series_california = eia_cats(3389936)

list_perim = c(&quot;US48&quot;, &quot;CAL&quot;, &quot;NY&quot;)
list_perim_label = c(&quot;Etats-Unis&quot;, &quot;Californie&quot;, &quot;New York&quot;)
list_lockdown_dates = c(as_datetime(&quot;2020-03-20 21:00:00&quot;),
                        as_datetime(&quot;2020-03-19 21:00:00&quot;),
                        as_datetime(&quot;2020-03-20 21:00:00&quot;))

list_utc_adj = c(5, 7, 5)

# time_now = Sys.time()
time_now = with_tz(now(), &quot;Europe/Paris&quot;)
  
source_ = paste(&quot;Source : EIA, &quot;, sprintf(&quot;Fait le : %s&quot;, time_now))

list_data = list()

for(perim in list_perim){
  print(perim)
  perim_id = which(list_perim[] == perim)
  
  perim_label = list_perim_label[perim_id]
  intercept_time = list_lockdown_dates[perim_id]
  utc_adj = list_utc_adj[perim_id]
  
  subtt_perim = sprintf(&quot;Début du confinement : %s\n%s&quot;,
                        intercept_time, source_)
  
  series = sprintf(&quot;EBA.%s-ALL.D.H&quot;, perim)
  
  EBA.US48_ALL.D.H = eia_series(series)
  
  EBA.US48_ALL.D.H_data = EBA.US48_ALL.D.H %&gt;%
    pull(data) %&gt;% 
    as.data.frame()
  
  today_week = week(today())
  first_week = today_week - 11
  
  EBA.US48_ALL.D.H_data4 = EBA.US48_ALL.D.H_data %&gt;% 
    mutate(date = date %m-% hours(utc_adj)) %&gt;% 
    mutate(date_ = as.Date(date, &quot;%Y-%m-%d&quot;)) %&gt;% 
    mutate(weekend = wday(date_)) %&gt;% 
    mutate(weekend = case_when(weekend %in% c(1,7) ~ TRUE,
                               TRUE ~ FALSE)) %&gt;% 
    mutate(hour = hour(date)) %&gt;% 
    mutate(value_no2020 = case_when(year == 2020 ~ NA_real_, 
                                    TRUE ~ value)) %&gt;% 
    group_by(hour, week, weekend) %&gt;% 
    mutate(mean_hour_week = mean(value_no2020, na.rm = T),
           min_hour_week = min(value_no2020, na.rm = T),
           max_hour_week = max(value_no2020, na.rm = T)) %&gt;% 
    ungroup() %&gt;% 
    select(value, mean_hour_week, date, week, hour, weekend) %&gt;% #min_hour_week, max_hour_week,
    dplyr::rename(demand = value) %&gt;% 
    pivot_longer(-c(&quot;date&quot;, &quot;week&quot;, &quot;hour&quot;, &quot;weekend&quot;), values_to = &quot;value&quot;, names_to = &quot;label&quot;) %&gt;% 
    filter(week &gt;= first_week &amp; week &lt;= today_week) %&gt;% 
    mutate(year = year(date)) %&gt;% 
    filter(year == 2020) %&gt;% 
    mutate(label_ = case_when(label == &quot;demand&quot; ~ &quot;Demande 2020&quot;,
                              label == &quot;mean_hour_week&quot; ~ &quot;Demande moyenne 2015-2019&quot;)) %&gt;% 
    mutate(week_label = factor(paste(&quot;semaine&quot;, week), levels = paste(&quot;semaine&quot;, 1:55))) %&gt;% 
    mutate(perim = perim_label)
  
  list_data[[length(list_data)+1]] = EBA.US48_ALL.D.H_data4
  
  gg_focus = 
  ggplot(EBA.US48_ALL.D.H_data4, aes(x = date, y = value, colour = label_)) +
    facet_wrap(~week_label, scales = &quot;free_x&quot;) +
    geom_line(size = 1) +
    ggthemes::theme_stata() +
    ggtitle(sprintf(&quot;Consommation éléctrique hebdomadaire - %s&quot;, perim_label)) +
    theme(
      plot.title   = element_text(lineheight = 0.8, face = &quot;bold&quot;, hjust = 0.5, size = 18),
      axis.text.x  = element_text(angle = 15, hjust = 1),
      axis.text.y  = element_text(angle = 0, hjust = 1),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      legend.title = element_blank(),
      legend.position = &quot;bottom&quot;
    ) 
  if(perim != &quot;US48&quot;){
    gg_focus = gg_focus +
      geom_vline(xintercept = intercept_time,linetype = &quot;dashed&quot;) +
      labs(subtitle = subtt_perim) 
  }else{
    gg_focus = gg_focus +
      labs(subtitle = source_) 
  }
  assign(sprintf(&quot;gg_conso_electr_%s&quot;, perim), gg_focus)
}

# gg_conso_electr_NY
# gg_conso_electr_CAL
# gg_conso_electr_US48

time_end = Sys.time()
run_time = as.numeric(time_end - time_start)

export_graph(gg_conso_electr_US48, perim = &quot;US&quot;, run_time = run_time,
             folder_name = &quot;us_electr_consumption_US&quot;, update = T)

export_graph(gg_conso_electr_CAL, perim = &quot;US&quot;, run_time = run_time,
             folder_name = &quot;us_electr_consumption_CAL&quot;, update = T)

export_graph(gg_conso_electr_NY, perim = &quot;US&quot;, run_time = run_time,
             folder_name = &quot;us_electr_consumption_NY&quot;, update = T)</code></pre>

